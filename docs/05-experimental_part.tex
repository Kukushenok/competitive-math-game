\chapter{Исследовательская часть}
Цель исследования~---~сравнить зависимость времени выдачи наград от количества вознаграждаемых игроков в двух случаях: при помощи хранимой процедуры и при помощи обычных запросов.

Исследование выполнялись на вычислительной машине со следующими характеристиками:
\begin{itemize}
	\item процессор Intel(R) Core(TM) i7-7700K 4.20 ГГц 4.20 ГГц.~\cite{intel};
	\item количество ядер процессора 4, количество потоков 8;
	\item объём оперативной памяти 32 ГБ.
\end{itemize}

Описание способов выдачи наград:
\begin{itemize}
	\item на стороне базы данных~---~вызов хранимой процедуры;
	\item на стороне приложения~---~реализация логики добавления наград с помощью Entity Framework Core.
\end{itemize}

Для создания различных входных данных, создаются независимые варианты базы данных, инициализируемые различными параметрами. Для создания независимых образов Postgre-SQL использовалась библиотека Testcontainers.Postgresql~\cite{testcontainers}

Исследование проводилось в два этапа: подготовка данных и замеры времени.

На каждую подготовку данных выделялся отдельный образ PostgreSQL, которым был инициализирован сценарием (см. листинг~\ref{code:init.sql} приложения Б). Программа заполняла СУБД нужными данными, после чего делала снимок базы данных при помощи pg\_dump~\cite{postgresql_pgdump} в файл. Для заполнения базы данных случайными данными использовалась библиотека Bogus~\cite{bogus}.

Если снимок данных подготавливался для $N$ выдаваемых наград, генерировалось:
\begin{itemize}
	\item 1 соревнование;
	\item $N/2$ участников и записей в таблицы лидеров;
	\item 5 критериев наград, каждый из которых вознаграждает $\frac{N}{5}$ участников.
\end{itemize}
Критерии выдачи наград генерировались с равной вероятностью двух возможных видов~--~по месту или по рангу. Параметр $N \in \{250, 500, 1000, 2000, 3000, 4000, 5000\}$.

На каждый замер времени выделялся отдельный образ PostgreSQL, который был инициализирован снимком базы данных, полученным на этапе подготовке данных. После этого, выполнялся один замер времени выдачи наград на стороне БД/приложения. Для измерения реального времени работы использовался класс Stopwatch~\cite{stopwatch}.

Для каждого параметра $N$ подготавливалось $10$ вариантов входных данных. Для каждого варианта входных данных было произведено $30$ замеров. Итоговое время работы для одного параметра $N$ является усреднённым временем по $300$ значениям.

В таблице~\ref{tbl:b_log} приведены результаты исследования.

\begin{longtable}{|p{.2\textwidth - 2\tabcolsep}|S|S|}
	\caption{Время выполнения от количества дополнительных потоков}\label{tbl:b_log}\\\hline
	Кол-во наград & \multicolumn{2}{c|}{Время, мс} \\\cline{2-3}
	& \multicolumn{1}{c|}{На стороне базы данных} & \multicolumn{1}{c|}{На стороне приложения} \\\hline
	\endfirsthead
	\caption{Время выполнения от количества дополнительных потоков (продолжение)}\\\hline
	Кол-во наград & \multicolumn{2}{c|}{Время, мс} \\\cline{2-3}
	& \multicolumn{1}{c|}{На стороне базы данных} & \multicolumn{1}{c|}{На стороне приложения} \\\hline
	\endhead
	\endfoot
	250	& 26.2485 & 43.8758 \\\hline
	500	& 35.4606 & 64.9545 \\\hline
	1000	& 45.4333 & 107.0000 \\\hline
	2000	& 67.2545 &171.0727 \\\hline
	3000	& 90.6091 & 242.9091 \\\hline
	4000	& 116.9364 & 342.6629 \\\hline
	5000	& 128.8848 & 365.5333 \\\hline
\end{longtable}

При помощи метода наименьших квадратов были найдены коэффициенты полинома 3 степени, аппроксимирующие данные точки. Время на стороне базы данных аппроксимирует функция формулы~(\ref{formula:t_1}); время на стороне приложения~---~формула~(\ref{formula:t_2}).
\begin{equation}
	\label{formula:t_1}
	t_1(N) = -5.774\cdot 10^{-10} \cdot N^3 + 3.743\cdot10^{-6}\cdot N^2 +1.684\cdot10^{-2}\cdot N + 24.066
\end{equation}
\begin{equation}
	\label{formula:t_2}
	t_2(N) = -2.76\cdot 10^{-9} \cdot N^3 + 1.888\cdot10^{-5}\cdot N^2 +  4.087\cdot10^{-2}\cdot N + 38.777 
\end{equation}
Исходя из того, что коэффициенты при $N^3$ и $N^2$ достаточно малы ($<10^{-4}$), зависимость времени выдачи наград от количества выдаваемых наград близка к линейной зависимости.

По результатам исследования, время работы на стороне сервера меньше, чем время работы на стороне приложения. При этом, линейный коэффициент роста времени на стороне приложения в $2.427$ раза больше, чем на стороне сервера.

По данным таблицы~\ref{tbl:b_log} построены графики, представленные на рисунке~\ref{graph:core}.

\graph{core}{Графики зависимостей времени выдачи наград от количества выдаваемых наград}
\section*{Вывод}

Проведено исследование времени выдачи наград от количества вознаграждаемых игроков в двух случаях: при помощи хранимой процедуры и при помощи обычных запросов. Время работы на стороне сервера меньше, чем время работы на стороне приложения. Зависимость времени от количества наград в обоих случаях близка к линейной, при этом линейный коэффициент роста времени на стороне приложения в $2.427$ раза больше, чем на стороне сервера. Следовательно, использование хранимой процедуры для вознаграждения пользователей целесообразно для уменьшения времени данной операции.

\clearpage

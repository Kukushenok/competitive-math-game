\chapter{Конструкторская часть}

%Программное обеспечение функционально должно обеспечивать
Поскольку база данных соревновательной игры является общей для всех игроков, программное обеспечение должно обеспечить Web-интерфейс взаимодействия с базой данных. Дополнительно, возможно предусмотреть консольный интерфейс для проверки базового функционала.
%Программное обеспечение должна предоставлять пользователю следующие возможности
\section{Описание сущностей базы данных}

Используются следующие сокращения для обозначения ограничений на поля сущности:
\begin{itemize}
	\item PK~---~первичный ключ;
	\item FK~---~внешний ключ;
	\item U~---~значение уникально в рамках таблицы;
	\item NN~---~пустое значение поля недопустимо.
\end{itemize}

В таблицах~\ref{db_table:account}-\ref{db_table:playerreward} указаны описания полей таблиц и ограничения целостности. 

\newenvironment{dbtable}[2]{
\begin{table}[h!]
	\caption{\label{db_table:#1} #2 }
	\begin{tabular}{|p{3cm}|p{3cm}|p{6cm}|p{3cm}|}
	\hline
	Поле & Тип & Описание & Ограничения \\\hline
}
{
\end{tabular}
\end{table}
}

\begin{dbtable}{account}{Описание таблицы account}
	ID & int & Идентификатор & PK \\\hline
	login & varchar(32) & Логин игрока & U \\\hline
	password\_hash & varchar & Хэш пароля & \\\hline
	email & varchar & Почта & \\\hline
	privilegy\_level & int & Категория пользователя &\\\hline
	profile\_image & bytea & Изображение профиля &\\\hline
	description & varchar & Описание профиля &\\\hline
\end{dbtable}

Дополнительные ограничения к таблице~\ref{db_table:account}: login не содержит пробелов.
Для обеспечения безопасности, поле "хэш пароля" у таблицы аккаунтов должно быть недоступно для всех категорий пользователей.

\begin{dbtable}{competition}{Описание таблицы competition}
	ID & int & Идентификатор & PK \\\hline
	competition\_name & varchar(64) & Название соревнования & NN \\\hline
	description & varchar(128) & Описание соревнования & \\\hline
	start\_time & timestamp & Время начала соревнования & NN \\\hline
	end\_time & timestamp & Время конца соревнования & NN\\\hline
	has\_ended & bool & Закончилось ли соревнование? (выданы ли награды) &NN\\\hline
\end{dbtable}

Дополнительные ограничения к таблице~\ref{db_table:competition}: время конца всегда больше времени начала.

\begin{dbtable}{participation}{Описание таблицы player\_participation}
	competition\_ID & int & Идентификатор соревнования & FK, NN \\\hline
	account\_ID & int & Идентификатор игрока & FK, NN \\\hline
	score & int & Очки & NN \\\hline
	last\_update\_time & timestamp & Последнее время обновления результата & \\\hline
\end{dbtable}

Дополнительные ограничения к таблице~\ref{db_table:participation}: пара значений competition\_ID и account\_ID уникально в рамках таблицы.

\begin{dbtable}{rewarddescription}{Описание таблицы reward\_description}
	ID & int & Идентификатор & PK \\\hline
	reward\_name & varchar(64) & Название награды & NN \\\hline
	description & varchar(128) & Описание награды & \\\hline
	icon\_image & bytea & Изображение награды & \\\hline
\end{dbtable}

Тип condition\_type\_enum является перечисляемым типом, возможными значениями которого являются 'rank' и 'place'. 

\begin{dbtable}{competitionreward}{Описание таблицы competition\_reward}
	ID & int & Идентификатор & PK \\\hline
	reward\_descrip-tion\_id & int & Идентификатор описания награды & FK, NN \\\hline
	competition\_id & int & Идентификатор соревнования & FK, NN \\\hline
	condition\_type & condition\_type\_e-num & Тип критерия выдачи наград & NN \\\hline
	min\_place & int & Минимальное место & \\\hline
	max\_place & int & Максимальное место & \\\hline
	min\_rank & decimal(4,3) & Минимальный ранг & \\\hline
	max\_rank & decimal(4,3) & Максимальный ранг & \\\hline
\end{dbtable}
Дополнительные ограничения к таблице~\ref{db_table:competitionreward}: 
\begin{itemize}
	\item если condition\_type = rank, то соблюдается соотношение $0\leq min\_rank \leq max\_rank\leq 1$ и соответствующим полям присвоено не пустое значение.
	\item если condition\_type = place, то соблюдается соотношение $1\leq min\_place\leq max\_place$ и соответствующим полям присвоено не пустое значение.
\end{itemize}

\begin{dbtable}{competitionlevel}{Описание таблицы competition\_level}
	ID & int & Идентификатор & PK \\\hline
	competition\_id & int & Идентификатор соревнования & FK, NN \\\hline
	platform & varchar(32) & Название платформы уровня & NN \\\hline
	version\_key & int & Версия уровня & NN \\\hline
	level\_data & bytea & Данные об уровне соревнования & NN\\\hline
\end{dbtable}


\begin{dbtable}{playerreward}{Описание таблицы player\_reward}
	ID & int & Идентификатор & PK \\\hline
	reward\_descript-ion\_id & int & Идентификатор описания награды & FK, NN \\\hline
	player\_id & int & Идентификатор игрока & FK, NN \\\hline
	competition\_id & int & Идентификатор соревнования & FK \\\hline
	creation\_date & timestamp & Дата создания награды & NN \\\hline
\end{dbtable}



\FloatBarrier

На рисунке~\ref{scheme:db} представлена схема базы данных соревновательной игры.

\scheme{db}{Схема базы данных соревновательной игры}

\section{Функциональная модель}
При истечении срока соревнования, игрокам должны быть выданы награды, исходя из таблицы лидеров. Награды соревнования выдаются всем участникам в таблице лидеров, которые подошли под критерий выдачи награды. После этого, для соревнования устанавливается, что награды за него выданы, чтобы избежать повторных вознаграждений.

Схема хранимой процедуры выдачи наград представлена на рисунках~\ref{scheme:procedure_1},~\ref{scheme:procedure_2}~\ref{scheme:procedure_3}.
\scheme{procedure_1}{Хранимая процедура выдачи наград}
\scheme{procedure_2}{Хранимая процедура выдачи наград}
\scheme{procedure_3}{Хранимая процедура выдачи наград}

Доступ на чтение поля password\_hash таблицы account ограничен. Следует определить функцию на уровне базы данных, которая сравнивает хэши паролей, чтобы предоставить возможность определять правильность пароля. Схема представлена на рисунке~\ref{scheme:hashprocedure}

\scheme{hashprocedure}{Хранимая процедура сравнения хэшей паролей}

Поскольку соревнование автоматически завершается по истечению срока, в программе должен быть предусмотрен отдельный процесс, который подключается к базе данных и вызывает хранимую процедуру выдачи наград, что требует дополнительного компонента постановки задач с отложенным выполнением. Процессу, который стоит за данным компонентом, назначен термин "демон выдачи наград".

У администратора имеется возможность загрузить на сервер изображение для типа награды в виде файла. Для обеспечения целостности, должна быть выполнена проверка содержимого, что данный файл является изображением.

\section{Ролевая модель}
В рамках задачи было выделено четыре роли на уровне базы данных:
\begin{itemize}
	\item гость,
	\item игрок,
	\item админинстратор,
	\item демон выдачи наград.
\end{itemize}
Гость имеет следующие возможности:
\begin{itemize}
	\item читать данные из таблиц competition, competition\_reward, player\_participation, reward\_des-cription, competition\_level;
	\item читать из таблицы account все поля, кроме password\_hash;
	\item добавлять новые данные в таблицу account (создавать новый аккаунт);
	\item вызвать хранимую процедуру check\_password\_hash.
\end{itemize}
Игрок имеет все возможности, что имеет гость. Дополнительно, он имеет следующие возможности:
\begin{itemize}
	\item обновлять таблицу account по полям username, description, profile\_image;
	\item добавлять данные и обновлять таблицу player\_participation;
	\item читать таблицу player\_reward
\end{itemize}
Админ имеет все возможности, что имеет гость. Дополнительно, он имеет следующие возможности:
\begin{itemize}
	\item удалять данные из player\_participation;
	\item читать, добавлять, изменять, удалять данные из player\_reward, competition\_level;
	\item добавлять, изменять данные из таблиц competition, competition\_reward, reward\_description.
\end{itemize}
Демон выдачи наград имеет следующие возможности:
\begin{itemize}
	\item вызвать хранимую процедуру grant\_rewards();
	\item читать и изменять данные из таблицы competition;
	\item читать данные из таблиц player\_participation, competition\_reward;
	\item добавлять данные в таблицу player\_reward.
\end{itemize}


\section*{Вывод}

Спроектирована архитектура базы данных и ограничения целостности. Спроектированы хранимые процедуры выдачи наград и проверки хэша пароля.
\clearpage

# upstream'ы — замените адреса на реальные backend'ы
upstream api_v1_backend {
    server competitivebackend:8080;   # ваш REST API v1
}

upstream db_admin_backend {
    server adminer:8080;   # например, Adminer / pgAdmin / phpMyAdmin
}

server {
    listen 80;
    server_name example.com;  # замените на ваш домен или _

    # Корень для основной статики
    root /var/www/static;
    index index.html;

    location = /api/v1/ {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Проксируем на swagger UI
        proxy_pass http://api_v1_backend/;
        proxy_redirect off;
        
        # Переписываем путь для swagger
        rewrite ^/api/v1/(.*)$ /swagger/$1 break;
        
        proxy_read_timeout 90;
    }

    # Если нужен отдельный endpoint для API (не swagger)
    location /api/v1/ {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_pass http://api_v1_backend/api/;
        proxy_read_timeout 90;
    }

    # ---------- 2) /legacy: если есть статические файлы — отдаём их; если нет — проксируем к legacy backend; если и того нет — отдаём страницу скачивания ----------
    # Проверка наличия файлов реализована через try_files: если файл найден в /var/www/legacy -> отдать.
    # Если нет — переходим в named location @legacy_backend (проксируем). Если и прокси недоступен — можно
    # вручную положить файл /var/www/legacy-download/index.html с ссылкой на скачивание.
    location /legacy/ {
        root /var/www;  # рабочая директория: /var/www/legacy/index.html будет доступен по /legacy/index.html
        # сначала попробовать статические файлы (если у вас лежит старая MPA/SPA)
        try_files $uri $uri/ @legacy_backend;
    }

    # Альтернативный fallback: если у вас нет legacy backend, используйте статическую страницу с ссылкой на скачивание:
    # разместите /var/www/legacy-download/index.html и завяжите редирект:
    location = /legacy {
        # если вы хотите, чтобы /legacy (без слеша) перенаправлял на /legacy/
        return 301 /legacy/;
    }

    location = /documentation {
        alias /var/www/documentation/index.html;
    }

    location /documentation/ {
        alias /var/www/documentation/;
        autoindex off;
    }
    # ---------- 5) /admin -> проксирование к веб-админке БД ----------
    location /admin {
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_pass http://db_admin_backend/;
        # Настоятельно: защитите /admin (basic auth, IP whitelist или через внешнюю авторизацию)
    }

    # ---------- 6) /status -> nginx stub_status ----------
    # Включите ngx_http_stub_status_module (обычно уже в поставке nginx).
    location /status {
        stub_status on;
        access_log off;
        allow 127.0.0.1;
        allow ::1;
        deny all;
    }

    # ---------- 7) /management -> простая HTML-страница со ссылками ----------
    location /management {
        alias /var/www/management/index.html;
        try_files /var/www/management/index.html =404;
    }

    # ---------- Статические ассеты (картинки, css, js) ----------
    location /static/ {
        alias /var/www/static/;
        try_files $uri $uri/ =404;
        expires 7d;
        access_log off;
    }
    location = / {
        # отдаём /var/www/static/index.html
        try_files /index.html =404;
    }
    location / {
        # Отдаем 404 для несуществующих файлов вместо перенаправления на index.html
        try_files $uri $uri/ =404;
    }
    location = /reserved {
        return 301 /reserved/;
    }
    # /reserved/ отдаёт ту же страницу что и /
    location /reserved/ {
        try_files $uri $uri/ /index.html;
    }
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";

    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
}

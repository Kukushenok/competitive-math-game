# upstream'ы — замените адреса на реальные backend'ы
upstream api_v1_backend {
    server competitivebackend:8080;
}

upstream db_admin_backend {
    server adminer:8080;
}

server {
    listen 80;
    server_name _;
    
    ###########################
    # 1) /api/v1/ + прокси swagger - ИСПРАВЛЕНО
    ###########################
    # Редирект /api/v1 на /api/v1/
    # Обработка /api/v1 (без слеша) - отдаем index.html напрямую
    location = /api/v1 {
        alias /var/www/swagger/;
        try_files /index.html =404;
        default_type "";
        autoindex off;
        expires 1h;
        access_log off;
    }

    # Обработка /api/v1/ - отдаем index.html для корня и файлы/прокси для остального
    location /api/v1/ {
        alias /var/www/swagger/;
        index index.html;
        
        # Если запрос к /api/v1/ - отдаем index.html, иначе ищем файлы или проксируем
        try_files $uri $uri/ /api/v1/index.html @api_v1_backend;
        
        default_type "";
        autoindex off;
        expires 1h;
        access_log off;
    }

    # Прокси для API backend
    location @api_v1_backend {
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_pass http://api_v1_backend;
        proxy_read_timeout 90;

        proxy_redirect ~^http://[^:]+(:\d+)?(/.*)$ $scheme://$host:$server_port$2;
    }
    ###########################
    # 2) Корень / - ИСПРАВЛЕНО
    ###########################
    
    # Обработка корневого пути
    location = / {
        root /var/www/static;
        try_files /index.html =404;
        expires 1h;
        access_log off;
    }

    ###########################
    # 3) /documentation -> /documentation/
    ###########################
    location = /documentation {
        alias /var/www/documentation/;
        try_files /index.html =404;
        autoindex off;
        expires 1h;
        access_log off;
    }

    location /documentation/ {
        root /var/www;
        index index.html;
        default_type text/plain;
        try_files $uri $uri/ /documentation/index.md =404;
        access_log off;
        expires 1h;
    }

    ###########################
    # 4) /legacy/ — статические или прокси-фоллбек
    ###########################
    location /legacy/ {
        root /var/www/;
        index index.html;
        try_files $uri $uri/ ;
    }

    location = /legacy {
        alias /var/www/legacy/;
        try_files /index.html =404;
        autoindex off;
        expires 1h;
        access_log off;
    }

    ###########################
    # 5) /admin -> прокси
    ###########################
    location = /admin {
        return 301 /admin/;
    }

    location /admin/ {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_pass http://db_admin_backend/;
        proxy_redirect ~^http://[^/]+(/.*)$ $scheme://$http_host$1;
    }

    ###########################
    # 6) /status (stub) и /status-ui (styled) — без ограничения доступа
    ###########################
    location = /status {
        stub_status on;
    }
    ###########################
    # 7) /management
    ###########################
    location = /management {
        return 301 /management/;
    }
    location /management/ {
        root /var/www;
        try_files /management/index.html =404;
    }

    ###########################
    # 8) Статика: /static/
    ###########################
    location /static/ {
        root /var/www;
        try_files $uri $uri/ =404;
        expires 7d;
        access_log off;
    }

    ###########################
    # 9) /reserved/ — отдать те же файлы что и / 
    ###########################
    location = /reserved {
        return 301 /reserved/;
    }

    location ^~ /reserved/ {
        root /var/www/static;

        # Убираем префикс /reserved/ только для поиска файлов
        rewrite ^/reserved/(.*)$ /$1 break;

        index index.html;

        # Сначала ищем реальный файл (JS, CSS, картинки и т.д.)
        # Только если файла НЕТ — отдаём index.html (SPA fallback)
        try_files $uri $uri/ /index.html;

        # MIME-типы корректно определяются nginx'ом самими расширениями
        default_type "";
        autoindex off;
        access_log off;
        expires 7d;
    }

    ###########################
    # 10) catch-all для статики - ИСПРАВЛЕНО
    ###########################
    location / {
        root /var/www/static;
        try_files $uri $uri/ =404;
    }

    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";

    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
}